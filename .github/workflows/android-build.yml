name: Android Release Build

# This workflow triggers on a push to the 'main' branch or when a new tag is pushed (for releases).
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from the GitHub Actions tab

jobs:
  build:
    # Use a standard Linux runner for the build process
    runs-on: ubuntu-latest
    
    # Define environment variables for the build process
    env:
      # Use an appropriate Java version for modern Android development
      JAVA_VERSION: '17'
      # The main Gradle build command to generate the release APK
      GRADLE_COMMAND: assembleRelease

    steps:
    - name: Checkout Repository
      # Checks out the repository code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      # Sets up the Java Development Kit environment
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: gradle # Caches Gradle dependencies for faster builds

    - name: Grant Execute Permission to gradlew
      # Ensures the Gradle wrapper script is executable
      run: chmod +x gradlew

    - name: Run Unit Tests (Optional but Recommended)
      # Run any existing unit tests before building the APK
      run: ./gradlew testReleaseUnitTest

    - name: Build Release APK
      # Executes the Gradle command to build the release APK
      run: ./gradlew ${{ env.GRADLE_COMMAND }}

    - name: Determine APK path
      # Finds the path to the generated APK file, accommodating different naming conventions.
      id: find_apk
      run: |
        APK_PATH=$(find app/build/outputs/apk/release/ -name "app-release.apk" -o -name "*-release.apk" | head -n 1)
        if [ -z "$APK_PATH" ]; then
          echo "Error: Could not find release APK file."
          exit 1
        fi
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

    - name: Upload Release APK as Artifact
      # Uploads the built APK file so it can be downloaded from the workflow run summary
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: ${{ steps.find_apk.outputs.apk_path }}
        # The APK path is typically: app/build/outputs/apk/release/app-release.apk
        # Note: If you have different flavor or module names, adjust the path above.
